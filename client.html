<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>MPGram Web — Клиент через GitHub Pages</title>
    <meta name="description" content="Статическая страница-переходник для MPGram Web. Хостится на GitHub Pages и перенаправляет в backend (PHP) сервер.">
    <link rel="icon" href="favicon.ico">
    <style>
        :root { --bg:#0f1320; --card:#161b2e; --text:#e8ecf1; --muted:#9aa7b3; --accent:#5ea3ff; --ok:#7ef0c1; }
        * { box-sizing: border-box; }
        html, body { height: 100%; }
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", sans-serif; color: var(--text); background: radial-gradient(1200px 800px at 85% -10%, rgba(94,163,255,.18), transparent 60%), radial-gradient(1000px 700px at -10% -10%, rgba(126,240,193,.16), transparent 60%), var(--bg) url('img/bg640.png') center/cover fixed no-repeat; }
        a { color: var(--accent); text-decoration: none; }
        a:hover { text-decoration: underline; }
        .wrap { min-height: 100%; display: grid; place-items: center; padding: 24px; }
        .card { width: 100%; max-width: 760px; background: rgba(22,27,46,.94); border: 1px solid rgba(255,255,255,.06); border-radius: 14px; padding: 20px; backdrop-filter: saturate(120%) blur(6px); }
        h1 { margin: 0 0 8px; font-size: 24px; }
        p { margin: 6px 0 12px; color: var(--muted); }
        .row { display: grid; grid-template-columns: 1fr auto; gap: 10px; margin: 12px 0 18px; }
        input[type="url"], input[type="text"] { width: 100%; padding: 12px 12px; border-radius: 10px; border: 1px solid rgba(255,255,255,.14); background: rgba(255,255,255,.02); color: var(--text); }
        .actions { display: flex; flex-wrap: wrap; gap: 10px; }
        button, .btn { cursor: pointer; padding: 12px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,.14); background: linear-gradient(180deg, rgba(94,163,255,.18), rgba(94,163,255,.06)); color: white; font-weight: 600; }
        .btn.alt { background: linear-gradient(180deg, rgba(126,240,193,.18), rgba(126,240,193,.06)); }
        .hint { font-size: 12px; color: var(--muted); margin-top: 8px; }
        .ok { color: var(--ok); font-weight: 600; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        @media (max-width: 640px) { .row { grid-template-columns: 1fr; } .grid { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="wrap">
        <div class="card">
            <h1>MPGram Web: запуск клиента</h1>
            <p>Эта страница хостится на GitHub Pages и перенаправляет вас в ваш backend (где работает PHP-часть MPGram Web). Введите адрес развернутого сервера.</p>

            <label for="base">Адрес backend (с http/https):</label>
            <div class="row">
                <input id="base" type="url" placeholder="https://mp.example.com" autocomplete="on">
                <button id="save">Сохранить</button>
            </div>
            <div id="status" class="hint"></div>

            <div class="actions">
                <a class="btn" id="openLogin" href="#">Войти</a>
                <a class="btn" id="openChats" href="#">Открыть чаты</a>
                <a class="btn alt" id="openSettings" href="#">Настройки</a>
                <a class="btn" id="logout" href="#">Выход</a>
            </div>

            <div class="grid">
                <div>
                    <label for="peer">Перейти сразу в чат (peer/id):</label>
                    <div class="row" style="grid-template-columns: 1fr auto;">
                        <input id="peer" type="text" placeholder="@username, +invite, или numeric id">
                        <button id="openPeer">Открыть</button>
                    </div>
                    <div class="hint">Пример: <code>@durov</code> или <code>+AAAAAF...</code> или <code>123456789</code></div>
                </div>
                <div>
                    <div class="hint">Подсказка: backend — это домен/поддомен вашего сервера с MPGram Web (nginx + PHP). Примеры: <code>https://mp.example.com</code> или <code>http://localhost</code>.</div>
                </div>
            </div>

            <div class="hint" style="margin-top: 14px;">Адрес сохраняется в LocalStorage и будет использоваться в кнопках выше.</div>
        </div>
    </div>

    <script>
    (function(){
        const $ = (id) => document.getElementById(id);
        const key = 'mpgram_base_url';
        const input = $('base');
        const status = $('status');

        function norm(u){
            try{
                if(!/^https?:\/\//i.test(u)) return null;
                const url = new URL(u);
                url.pathname = url.pathname.replace(/\/$/, '');
                return url.origin + url.pathname;
            }catch(e){return null}
        }

        function sameOriginBase(){
            // Текущая папка (repo/subdir тоже учитывается)
            const {origin, pathname} = window.location;
            const basePath = pathname.replace(/\/[^\/]*$/, '');
            return origin + basePath;
        }

        async function probe(base){
            try{
                const url = base + '/login.php';
                const res = await fetch(url, { method: 'HEAD', cache: 'no-store' });
                return res.ok || res.status === 405; // 405 если HEAD запрещён — тоже нормально
            }catch(e){ return false; }
        }

        function save(){
            const v = norm(input.value.trim());
            if(!v){ status.textContent = 'Введите корректный URL, начинающийся с http:// или https://'; status.className='hint'; return; }
            try{ localStorage.setItem(key, v); status.innerHTML = '<span class="ok">Сохранено:</span> ' + v; }catch(e){ status.textContent = 'Не удалось сохранить: ' + e; }
        }

        function get(){
            try{ return localStorage.getItem(key) || ''; }catch(e){ return ''; }
        }

        function effectiveBase(){
            return norm(get()) || norm(input.value.trim());
        }

        function go(path){
            const base = effectiveBase();
            if(!base){ status.textContent = 'Сначала укажите и сохраните адрес backend.'; return; }
            window.location.href = base + path;
        }

        $('save').addEventListener('click', save);
        $('openLogin').addEventListener('click', (e)=>{ e.preventDefault(); go('/login.php'); });
        $('openChats').addEventListener('click', (e)=>{ e.preventDefault(); go('/chats.php'); });
        $('openSettings').addEventListener('click', (e)=>{ e.preventDefault(); go('/sets.php'); });
        $('logout').addEventListener('click', (e)=>{ e.preventDefault(); go('/login.php?logout=1'); });
        $('openPeer').addEventListener('click', (e)=>{ e.preventDefault(); const p=$('peer').value.trim(); if(!p){status.textContent='Укажите peer/id';return;} go('/chat.php?c='+encodeURIComponent(p)); });

        // init: 1) ?backend=... 2) saved 3) same-origin autodetect
        (async function init(){
            const params = new URLSearchParams(window.location.search);
            const qp = params.get('backend');
            if (qp) {
                const v = norm(qp);
                if (v) {
                    try { localStorage.setItem(key, v); } catch(e) {}
                    input.value = v;
                    status.innerHTML = '<span class="ok">Установлен backend из URL:</span> ' + v;
                    // Автоматически переходим на логин
                    go('/login.php');
                    return;
                }
            }
            const saved = get();
            if(saved){ input.value = saved; status.innerHTML = '<span class="ok">Текущий backend:</span> ' + saved; return; }
            const auto = sameOriginBase();
            input.value = auto;
            if(await probe(auto)){
                try{ localStorage.setItem(key, auto); }catch(e){}
                status.innerHTML = '<span class="ok">Обнаружен backend по месту размещения:</span> ' + auto;
            } else {
                status.textContent = 'Укажите адрес вашего backend (загрузите весь проект на PHP-хостинг или введите внешний домен).';
            }
        })();
    })();
    </script>
</body>
</html>


